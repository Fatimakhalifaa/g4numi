This document describes how to build a local copy of g4numi and GEANT4.

1.  Make a fresh working area:

% cd ~
% export User_release_area=/minerva/app/users/<you>/cmtuser
% source /grid/fermiapp/minerva/software_releases/vXrYpZ.sh
% setenvMinerva g4numi

g4numi is the name of this working area. You can call it whatever you want.
edit cmt/project.cmt so that it says:

project Minerva_g4numi

use MINERVA MINERVA_vXrYpZ

where XYZ are the version, release and patch number of the software release. You won't 
actually use it at all and it doesn't matter.

2.  In /minerva/app/users/<you>/cmtuser/Minerva_g4numi, checkout the g4numi package:

% cvs co NumiAna/numisoft/g4numi

3.  Log out, and log back in. Do NOT source any setup scripts, including the standard Minerva setup. 
Doing so will set some environment variables that you do not want.

Go to the g4numi area
% cd /minerva/app/users/<you>/cmtuser/Minerva_g4numi/NumiAna/numisoft/g4numi

Make a directory to put Geant4 in:
% mkdir geant4

Copy the geant4 source files from the FNAL afs area into your personal geant4 directory:
% cp -r /afs/fnal.gov/ups/geant4source/v4_9_2_p03/NULL-g77/geant4.9.2.p03 .

Copy some libraries to the "data" area of your geant4 installation. The "correct" way to do this is probably 
to configure your g4 installation to get the correct paths to these libraries. The easy way is to just copy 
them to the place that g4 thinks they should be.

% cd geant4.9.2.p03
% mkdir data
% cp -r /afs/fnal.gov/ups/g4photon/v2_0/NULL/PhotonEvaporation PhotonEvaporation2.0
% cp -r /afs/fnal.gov/ups/g4radiative/v3_2/NULL/RadioactiveDecay3.2 .
% cp -r /afs/fnal.gov/ups/g4neutron/v3_13/NULL/G4NDL3.13 .
% cp -r /afs/fnal.gov/ups/g4abla/v3_0/NULL/G4ABLA3.0 .
% cp -r /afs/fnal.gov/ups/g4emlow/v6_2/NULL/G4EMLOW6.2 .

You are now ready to build geant4.

4. Edit the configuration to compile with a 32-bit architecture. In geatn4.9.2.p03/config/sys, modify the file Linux-g++.gmk:

Add "CXXFLAGS += -m32" to the first block of code, so that it looks like this:

ifeq ($(G4SYSTEM),Linux-g++)
  CXX       := g++
  CXXFLAGS  := -W -Wall -ansi -pedantic -Wno-non-virtual-dtor -Wno-long-long
  CXXFLAGS  += -Wwrite-strings -Wpointer-arith -Woverloaded-virtual -pipe
  CXXFLAGS  += -m32

At the very end of the file, add -m32 to the $(CXX) lines, so that it looks like this:

  define build-granular-shared-lib
    @libdir=`(cd $(@D);/bin/pwd)`; \
     cd $(G4TMPDIR); \
     $(CXX) -m32 -Wl,-soname,$(@F) -shared -o $$libdir/$(@F) $(INTYLIBS) *.o
  endef
  define build-global-shared-lib
    @libdir=`(cd $(@D);/bin/pwd)`; \
     cd $(G4TMP)/$(G4SYSTEM); \
     $(CXX) -m32 -Wl,-soname,$(@F) -shared -o $$libdir/$(@F) $(INTYLIBS) \
                    $(foreach dir,$(SUBLIBS),$(dir)/*.o);
  endef

endif

5. Compile geant4.

% cd ..
% ./Configure -build

You will now be asked a bunch of questions. Almost all of them should be answered with the default (just hit enter),
but there are a few that you absolutely need to change, so pay attention.  The following is a complete list of the 
things you need to do that are NOT the default, in the order that you will encounter them.

When asked if you want to copy the include files to a single directory, enter: y
When prompted for the CLHEP_BASE_DIR, enter: /grid/fermiapp/products/minerva/prd/clhep/v2_0_4_5/Linux-2-6
When asked if you want to create shared (.so) libraries, enter: y
When asked if you want to build g3tog4, enter: y

All other questions, just hit enter for the default. After your first build, it will find a config.sh file with your 
settings saved, so you may just hold down enter until it starts compiling.

6. Go for coffee. The initial compile of geant4 takes about an hour on the minervagpvm machines under normal conditions. 

7. Go back to your g4numi area and source the beamsim script:

% cd /minerva/app/users/<you>/cmtuser/Minerva_g4numi/NumiAna/numisoft/g4numi
% source setup_beamsim.sh

8. type "make" to execute the GNUmakefile

9. If that works, then you should have an executable called "g4numi". Run a test job:

g4numi NuBeam_example.mac

The output file is g4numi_testing_8000.root


Modifying the code

Now you have a local copy of geant4 installed, and you want to make some flux predictions.

You can make changes to both Geant4 and g4numi.  If you change anything inside G4 (in the geant4 directory you created earlier),
you have to build geant again.  To do this, just go to the G4 area and do ./Configure -build again.  It will not take nearly as 
long, since most things will require no change.  If you change something outside of G4, like g4numi.cc or any of the files in 
g4numi/src, you just need to run the GNUmakefile again.

To change the physics list, just edit g4numi.cc. This is straightforward, and requires changing only one line of code, in addition 
to making sure you #include the list you are using.

To change the target or horn geometry, edit g4numi/src/NumiDataInput.cc. From this file, you can modify the horn alignment, horn 
currents, target density, etc.

Running the code

Once you have the configuration you want and it has been copiled using the GNUmakefile, you are ready to run it.  



